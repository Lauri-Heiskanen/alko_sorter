<head>
  <script type="text/javascript" src="xlsx.full.min.js"></script>
  <script>
    const number_of_products_to_render = 20; // this is based on nothing but vibes
    let currently_rendered_elements = 0;
    let current_sort_criteria = null;
    function disable_inputs() {}
    function enable_inputs() {}
    function render_products() {} // introduced here so elements can see it at load
    function clear_products() {
      product_container.innerText = formatted_product_data = "";
      currently_rendered_elements = 0;
    }
    function on_parameter_change() {
      disable_inputs();
      clear_products();
      render_products();
      enable_inputs();
    }

    window.onload = () => {
      const product_container = document.getElementById("product_container");
      const huomioi_pantti_checkbox = document.getElementById("pantti_checkbox");
      const sort_criteria_select = document.getElementById("sort_criteria_select");
      const reverse_sort_direction_checkbox = document.getElementById("reverse_sort_direction_checkbox");

      disable_inputs = () => {
        for (let element of document.getElementsByTagName("input")) {
          element.disabled = true;
        }
        for (let element of document.getElementsByTagName("select")) {
          element.disabled = true;
        }
      };

      enable_inputs = () => {
        for (let element of document.getElementsByTagName("input")) {
          element.disabled = false;
        }
        for (let element of document.getElementsByTagName("select")) {
          element.disabled = false;
        }
      };

      disable_inputs();

      current_sort_criteria = sort_criteria_select.options[sort_criteria_select.selectedIndex].value;

      const url =
        "https://www.alko.fi/INTERSHOP/static/WFS/Alko-OnlineShop-Site/-/Alko-OnlineShop/fi_FI/Alkon%20Hinnasto%20Tekstitiedostona/alkon-hinnasto-tekstitiedostona.xlsx";
      const local_url = "alkon-hinnasto-tekstitiedostona.xlsx";

      fetch(local_url).then((res) => {
        console.log(res);
        res.arrayBuffer().then((file) => {
          // read, convert and filter data
          const workbook = XLSX.read(file);
          const unfiltered_data = XLSX.utils.sheet_to_json(workbook["Sheets"]["Alkon Hinnasto Tekstitiedostona"], { range: 3 });
          const data = unfiltered_data.filter((element) => element["Alkoholi-%"] && element["Hinta"] && element["Pullokoko"] && element["Litrahinta"]);

          // calculate missing datapoints
          data.forEach((element) => {
            element["alc_cl_per_euro_pantti"] = element["Alkoholi-%"] / element["Litrahinta"];
          });
          data.forEach((element) => {
            element["Litrahinta_no_pantti"] = element["Hinta"] / element["Pullokoko"].split(" ")[0];
          });
          data.forEach((element) => {
            element["alc_cl_per_euro"] = element["Alkoholi-%"] / element["Litrahinta_no_pantti"];
          });

          const get_sort_value_function = (a) => {
            if (current_sort_criteria == "alc_cl_per_euro") {
              if (huomioi_pantti_checkbox.checked) {
                return (a) => a["alc_cl_per_euro_pantti"];
              } else {
                return (a) => a["alc_cl_per_euro"];
              }
            } else if (current_sort_criteria == "Litrahinta") {
              if (huomioi_pantti_checkbox.checked) {
                return (a) => a["Litrahinta"];
              } else {
                return (a) => a["Litrahinta_no_pantti"];
              }
            } else if (current_sort_criteria == "Pullokoko") {
              return (a) => a["Pullokoko"].split(" ")[0];
            } else {
              return (a) => a[current_sort_criteria];
            }
          };

          // define render function
          render_products = () => {
            // set amount of items to render
            const target_number_of_rendered_products =
              currently_rendered_elements + number_of_products_to_render > data.length
                ? data.length
                : currently_rendered_elements + number_of_products_to_render;

            // get sorting value function
            const get_sort_value = get_sort_value_function();

            if (reverse_sort_direction_checkbox.checked) {
              data.sort((a, b) => {
                return get_sort_value(a) - get_sort_value(b);
              });
            } else {
              data.sort((a, b) => {
                return get_sort_value(b) - get_sort_value(a);
              });
            }

            console.log(get_sort_value(data[0]));

            // create and append product elements
            while (currently_rendered_elements < target_number_of_rendered_products) {
              const product_element = document.createElement("div");
              product_element.style = "margin-top: 10px;margin-bottom: 10px; background: lightgray; padding: 10px;";
              product_element.innerHTML = `
        <h1">${data[currently_rendered_elements]["Nimi"]}</h1>
        <p>Alkoholi-%: ${data[currently_rendered_elements]["Alkoholi-%"]} %</p>
        <p>Koko: ${data[currently_rendered_elements]["Pullokoko"]}</p>
        <p>Hinta: ${data[currently_rendered_elements]["Hinta"]} €</p>
        <p>Litrahinta: ${data[currently_rendered_elements][huomioi_pantti_checkbox.checked ? "Litrahinta" : "Litrahinta_no_pantti"]}</p>
        <p>Annos / €: ${data[currently_rendered_elements][huomioi_pantti_checkbox.checked ? "alc_cl_per_euro_pantti" : "alc_cl_per_euro"] / 1.6}</p>
        <p>Tyyppi: ${data[currently_rendered_elements]["Tyyppi"]}</p>
        <a href="https://www.alko.fi/tuotteet/${data[currently_rendered_elements]["Numero"]}">https://www.alko.fi/tuotteet/${
                data[currently_rendered_elements]["Numero"]
              }</a>
              `;
              product_container.appendChild(product_element);
              currently_rendered_elements += 1;
            }
          };

          render_products();
          enable_inputs();

          // if end of page is reached, render more products
          window.onscroll = () => {
            if (window.scrollY + window.innerHeight > document.body.offsetHeight) {
              // disabling inputs isn't really necessary here but it doesn't really cost anything either
              disable_inputs();
              render_products();
              enable_inputs();
            }
          };
        });
      });
    };
  </script>
</head>
<body style="background: darkgray">
  <div style="margin-top: 10px; margin-bottom: 10px; background: lightgray; padding: 10px" ;>
    <label
      >Huomiodaanko pantti?
      <input type="checkbox" id="pantti_checkbox" onchange="on_parameter_change()" />
    </label>
    <br />
    <label> Järjestys </label>
    <select
      name="sort_criteria"
      id="sort_criteria_select"
      onclick="if (!event.target.disabled && current_sort_criteria != event.target.options[event.target.selectedIndex].value) {
        current_sort_criteria = event.target.options[event.target.selectedIndex].value;
        on_parameter_change()
      }"
    >
      <option value="Alkoholi-%">Alkoholi-%</option>
      <option value="Pullokoko">Koko</option>
      <option value="Hinta">Hinta</option>
      <option value="Litrahinta">Litrahinta</option>
      <option selected value="alc_cl_per_euro">Annos / €</option></select
    ><label
      >Reverse order
      <input type="checkbox" id="reverse_sort_direction_checkbox" onchange="on_parameter_change()" />
    </label>
  </div>
  <div id="product_container"></div>
</body>
